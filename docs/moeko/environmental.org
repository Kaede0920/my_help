#+qiita_private: a824683705cf79a8f296
#+OPTIONS: ^:{}
#+STARTUP: indent nolineimages
#+OPTIONS:   toc:nil
#+TAG: Ruby, test, my_help
#+SETUPFILE: https://fniessen.github.io/org-html-themes/org/theme-readtheorg.setup
* my_helpというアプリケーションをArubaを使ってテストしてみた．
  :PROPERTIES:
  :CUSTOM_ID: my_helpというアプリケーションをarubaを使ってテストしてみた
  :END:
今回は環境構築．

** 初めに
   :PROPERTIES:
   :CUSTOM_ID: 初めに
   :END:
[[https://github.com/daddygongon/my_help]["daddygongon/my_help"]]

上記のURLをクリックしてcodeのSSHをcopyする．

ターミナルにいき，

#+begin_src sh
> git clone 先ほどコピーしたSSHのアドレスを貼り付ける
#+end_src

とする．

これでmy_helpが入る．

** specファイルを作成
   :PROPERTIES:
   :CUSTOM_ID: specファイルを作成
   :END:
これではまだArubaでテストできるような仕様になっていない(rspecが入っていない)ため，ここからやっていく．
まず，specファイルを作る．

#+begin_example
> mkdir spec
#+end_example

この中にどんどん入れていく．
前に別のアプリケーションでRspecで環境構築したものがあったのでそれを使っていく

#+begin_example
--format documentation
--color
--require spec_helper
#+end_example

上記はmy_helpに作る(隠しファイル)

#+begin_example
require 'spec_helper'

RSpec.describe 'hello_thor',type: :aruba do
  context 'version option' do
    before(:each){run_command('hello_thor version')}
    it {expect(last_command_started).to be_successfully_executed}
  end
end
#+end_example

#+begin_example
 coding: utf-8                                                                                                         
# frozen_string_literal: true                                                                                           

RSpec.describe HelloThor do
  it "has a version number" do
    expect(HelloThor::VERSION).not_to be nil
  end

  describe "HelloThor::Hello" do
    subject(:hello){HelloThor::Hello.new}#主語                                                                          

    describe "run with no arg" do
      it {expect(hello.run).to eq('Hello world.')}
    end

    describe "run with an arg 'Moeko'" do
      it {expect(hello.run('Moeko')).to eq('Hello Moeko.')}
    end

  end
end
#+end_example

中身は違うアプリケーションからコピーしているため改良が必要(ファイル名が違う）

#+begin_example
 frozen_string_literal: true                                                                                           

require "my_help"

RSpec.configure do |config|
  # Enable flags like --only-failures and --next-failure                                                                
  config.example_status_persistence_file_path = ".rspec_status"

  # Disable RSpec exposing methods globally on `Module` and `main`                                                      
  config.disable_monkey_patching!

  config.expect_with :rspec do |c|
    c.syntax = :expect
  end
end
$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)

::Dir.glob(::File.expand_path('../support/*.rb', __FILE__)).each { |f| require_relative f }
::Dir.glob(::File.expand_path('../support/**/*.rb', __FILE__)).each { |f| require_relative f }
#+end_example

specファイルの中に上記３つを作る．

gemspecファイルを開いて,

#+begin_example
 s.add_development_dependency 'rspec'
#+end_example

をコメントアウト外す．そして，下記を追加

#+begin_example
s.add_runtime_dependency 'thor'
s.add_development_dependency 'aruba'
#+end_example

最終的にgemspecファイルは下記のようになる．

#+begin_example
require File.join([File.dirname(__FILE__),'lib','my_help','version.rb'])
spec = Gem::Specification.new do |s|
  s.name = 'my_help'
  s.version = MyHelp::VERSION
  s.author = 'Shigeot R. Nishitani'
  s.email = ''
  s.homepage = 'https://github.com/daddygongon/my_help'
  s.platform = Gem::Platform::RUBY
  s.license       = "MIT"
  s.summary       = %q{user building help}
  s.description   = %q{user building help}
  s.files         = `git ls-files -z`.split("\x0").reject do |f|
    f.match(%r{^(test|spec|features)/})
  end
  s.require_paths = ["lib"]
  s.bindir        = "exe"
  s.executables   = s.files.grep(%r{^exe/}) { |f| File.basename(f) }
  s.add_development_dependency 'rake'
  s.add_development_dependency 'rubocop'
  s.add_development_dependency 'rspec'
  s.add_development_dependency 'aruba'
  s.add_development_dependency 'yard'
  s.add_development_dependency 'test-unit'
  s.add_runtime_dependency 'thor'
  s.add_runtime_dependency "colorize"
  s.add_runtime_dependency "command_line"
end
#+end_example

そして，

#+begin_src sh
> bundle install
#+end_src

** Thorを確認
   :PROPERTIES:
   :CUSTOM_ID: thorを確認
   :END:
おそらく入っているので挙動確認する.

#+begin_src sh
> bundle exec rspec
#+end_src

** Arubaを入れる
   :PROPERTIES:
   :CUSTOM_ID: arubaを入れる
   :END:
[[https://qiita.com/tbpgr/items/41730edcdb07bb5b59ad]["Aruba
gemでCLIテストを支援する"]]

基本はこれ通りにしていくのだが，エラーが発生するので以下の記事に従って書き換える．

[[https://qiita.com/mek001/items/4c46af014f66b201288c]["Aruba gemでfizz
buzzテストを書いてみた"]]

最後に

#+begin_src sh
> bundle exec rspec
#+end_src

でok

これであとはspec/cli_spec.rbを書き加えていくとArubaのテストとなる．
