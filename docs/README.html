<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="jp" xml:lang="jp">
<head>
<!-- 2023-01-05 Thu 15:58 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>my_help 開発メモ</title>
<meta name="author" content="Shigeto R. Nishitani" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">my_help 開発メモ</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orge4fa5d5">1. <span class="timestamp-wrapper"><span class="timestamp">&lt;2022-12-15 Thu&gt; </span></span> subcommand and options</a></li>
<li><a href="#org66ec027">2. <span class="timestamp-wrapper"><span class="timestamp">&lt;2022-12-15 Thu&gt; </span></span> rspecでerror</a>
<ul>
<li><a href="#orgab3a666">2.1. 解決！！</a></li>
</ul>
</li>
<li><a href="#org18dc25e">3. <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-10-18 Mon&gt; </span></span> conf_pathの追加</a></li>
<li><a href="#org2aec50d">4. <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-11-08 Mon&gt; </span></span> conf_pathをactivate</a></li>
<li><a href="#org20943ec">5. <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-11-08 Mon&gt; </span></span> bundle exec exe/my_help editでエラー</a></li>
</ul>
</div>
</div>

<div id="outline-container-orge4fa5d5" class="outline-2">
<h2 id="orge4fa5d5"><span class="section-number-2">1.</span> <span class="timestamp-wrapper"><span class="timestamp">&lt;2022-12-15 Thu&gt; </span></span> subcommand and options</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li><a href="https://hawksnowlog.blogspot.com/2020/09/ruby-thor-tutorial.html#hello-thor">Ruby thor で CLI ツールの開発に入門してみる</a></li>
</ul>
</div>
</div>

<div id="outline-container-org66ec027" class="outline-2">
<h2 id="org66ec027"><span class="section-number-2">2.</span> <span class="timestamp-wrapper"><span class="timestamp">&lt;2022-12-15 Thu&gt; </span></span> rspecでerror</h2>
<div class="outline-text-2" id="text-2">
<p>
Arubaでrspecするとpwd directoryが/tmp/arubaになる？
そうすると今のままではrspecが通らなくなる．
example2.orgの置き場が不定．
spec側で強引に作るか．．．
</p>

<p>
それもsmartにしたいよね．
newでは後ろにoptionがあって，#{temp_dir}での作成とできるが，
これをその他のoptionsでやるのは難しそう．
</p>
</div>

<div id="outline-container-orgab3a666" class="outline-3">
<h3 id="orgab3a666"><span class="section-number-3">2.1.</span> 解決！！</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Arubaだけの問題なので，テストの時用にhelp_dirを
Thorのoptionとして引けるようにした．
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="linenr"> 1: </span>    desc <span style="color: #8b7355;">"list [HELP] [ITEM]"</span>, <span style="color: #8b7355;">"list helps"</span>
<span class="linenr"> 2: </span>    option <span style="color: #6e8b3d;">:help_dir</span>, <span style="color: #6e8b3d;">:type</span> =&gt; <span style="color: #6e8b3d;">:string</span>
<span class="linenr"> 3: </span>    <span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">use method_options [[https://github.com/rails/thor/wiki/Method-Options]]</span>
<span class="linenr"> 4: </span>    <span style="color: #1c86ee;">def</span> <span style="color: #cd9b1d;">list</span>(*args)
<span class="linenr"> 5: </span>      config = get_config(args).config
<span class="linenr"> 6: </span>      help_dir = options[<span style="color: #8b7355;">"help_dir"</span>] || config[<span style="color: #6e8b3d;">:local_help_dir</span>]
<span class="linenr"> 7: </span>      <span style="color: #cd6600;">puts</span> <span style="color: #00688b;">List</span>.new(help_dir,
<span class="linenr"> 8: </span>                    config[<span style="color: #6e8b3d;">:ext</span>]).list(*args.join(<span style="color: #8b7355;">" "</span>))
<span class="linenr"> 9: </span>    <span style="color: #1c86ee;">end</span>
<span class="linenr">10: </span>...
<span class="linenr">11: </span>  context <span style="color: #8b7355;">"list command"</span> <span style="color: #1c86ee;">do</span>
<span class="linenr">12: </span>    temp_dir = <span style="color: #00688b;">Dir</span>.pwd
<span class="linenr">13: </span>    let(<span style="color: #6e8b3d;">:help_name</span>) { <span style="color: #8b7355;">"example"</span> }
<span class="linenr">14: </span>    let(<span style="color: #6e8b3d;">:help_dir</span>) { <span style="color: #00688b;">File</span>.join(temp_dir, <span style="color: #8b7355;">"lib"</span>, <span style="color: #8b7355;">"templates"</span>) }
<span class="linenr">15: </span>
<span class="linenr">16: </span>    it <span style="color: #8b7355;">"list with name"</span> <span style="color: #1c86ee;">do</span>
<span class="linenr">17: </span>      run_command(<span style="color: #8b7355;">"my_help list </span><span style="color: #2e8b57;">#{help_name}</span><span style="color: #8b7355;"> a_item --help_dir=</span><span style="color: #2e8b57;">#{help_dir}</span><span style="color: #8b7355;">"</span>)
<span class="linenr">18: </span>      stop_all_commands
<span class="linenr">19: </span>      expect(last_command_started).to have_output(<span style="color: #8b7355;">/a_item/</span>)
<span class="linenr">20: </span>    <span style="color: #1c86ee;">end</span>
<span class="linenr">21: </span>  <span style="color: #1c86ee;">end</span>
<span class="linenr">22: </span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org18dc25e" class="outline-2">
<h2 id="org18dc25e"><span class="section-number-2">3.</span> <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-10-18 Mon&gt; </span></span> conf_pathの追加</h2>
<div class="outline-text-2" id="text-3">
<p>
my_help.confの場所を指定するconf_pathをnewで指定できるようにする．
</p>

<div class="org-src-container">
<pre class="src src-diff"><span class="linenr"> 1: </span><span style="color: #22aa22; background-color: #ddffdd;">&gt;</span><span style="background-color: #ddffdd;"> git diff</span>
<span class="linenr"> 2: </span><span style="background-color: #d9d9d9;">--- </span><span style="background-color: #bfbfbf; font-weight: bold;">a/lib/my_help/my_help_controll.rb</span>
<span class="linenr"> 3: </span><span style="background-color: #d9d9d9;">+++ </span><span style="background-color: #bfbfbf; font-weight: bold;">b/lib/my_help/my_help_controll.rb</span>
<span class="linenr"> 4: </span><span style="background-color: #d9d9d9;">@@ -5,13 +5,14 @@</span><span style="background-color: #d9d9d9;"> require 'yaml'</span>
<span class="linenr"> 5: </span> module MyHelp
<span class="linenr"> 6: </span>   class Control
<span class="linenr"> 7: </span>     attr_accessor :local_help_dir, :editor
<span class="linenr"> 8: </span><span style="color: #aa2222; background-color: #ffdddd;">-</span><span style="background-color: #ffdddd;">    def initialize()</span>
<span class="linenr"> 9: </span><span style="color: #22aa22; background-color: #ddffdd;">+</span><span style="background-color: #ddffdd;">    def initialize(</span><span style="background-color: #aaffaa;">conf_path=nil</span><span style="background-color: #ddffdd;">)</span>
<span class="linenr">10: </span>       # for configuration setups
<span class="linenr">11: </span>       # see https://stackoverflow.com/questions/6233124/where-to-place-access-config-file-in-gem
<span class="linenr">12: </span><span style="color: #aa2222; background-color: #ffdddd;">-</span>
<span class="linenr">13: </span><span style="color: #22aa22; background-color: #ddffdd;">+</span><span style="background-color: #ddffdd;">      </span><span style="background-color: #aaffaa;">@conf_path = conf_path || ENV['HOME']</span>
<span class="linenr">14: </span>       @template_dir = File.expand_path("../../templates", __FILE__)
<span class="linenr">15: </span>       @exe_dir = File.expand_path("../../exe", __FILE__)
<span class="linenr">16: </span><span style="color: #aa2222; background-color: #ffdddd;">-</span><span style="background-color: #ffdddd;">      @local_help_dir = File.join(</span><span style="background-color: #ffbbbb;">ENV[</span><span style="background-color: #ffdddd;">'</span><span style="background-color: #ffbbbb;">HOME</span><span style="background-color: #ffdddd;">'</span><span style="background-color: #ffbbbb;">]</span><span style="background-color: #ffdddd;">,'.my_help')</span>
<span class="linenr">17: </span><span style="color: #22aa22; background-color: #ddffdd;">+</span><span style="background-color: #ddffdd;">      @local_help_dir = File.join(</span><span style="background-color: #aaffaa;">@conf_path,</span><span style="background-color: #ddffdd;"> '</span><span style="background-color: #aaffaa;">.my_help</span><span style="background-color: #ddffdd;">'</span><span style="background-color: #aaffaa;">)</span><span style="background-color: #aaffaa;">
<span class="linenr">18: </span></span><span style="color: #22aa22; background-color: #aaffaa;">+</span><span style="background-color: #aaffaa;">      @conf_file = File.join(@local_help_dir</span><span style="background-color: #ddffdd;">, '.my_help</span><span style="background-color: #aaffaa;">_conf.yml</span><span style="background-color: #ddffdd;">')</span>
<span class="linenr">19: </span>       @editor = ENV['EDITOR'] || 'emacs' #'code', 'emacs' #'vim' #default editor
<span class="linenr">20: </span>       # @mini_account = File
<span class="linenr">21: </span>       set_help_dir_if_not_exists
<span class="linenr">22: </span><span style="background-color: #d9d9d9;">@@ -28,9 +29,6 @@</span><span style="background-color: #d9d9d9;"> module MyHelp</span>
<span class="linenr">23: </span>     end
<span class="linenr">24: </span> 
<span class="linenr">25: </span>     def load_conf
<span class="linenr">26: </span><span style="color: #aa2222; background-color: #ffdddd;">-</span><span style="background-color: #ffdddd;">      file_name = '.my_help_conf.yml'</span>
<span class="linenr">27: </span><span style="color: #aa2222; background-color: #ffdddd;">-</span><span style="background-color: #ffdddd;">      # @conf_file = File.join(Dir.pwd, file_name)</span>
<span class="linenr">28: </span><span style="color: #aa2222; background-color: #ffdddd;">-</span><span style="background-color: #ffdddd;">      @conf_file = File.join(@local_help_dir, file_name)</span>
<span class="linenr">29: </span>       begin
<span class="linenr">30: </span>         conf = YAML.load_file(@conf_file)
<span class="linenr">31: </span>         @editor = conf[:editor]
</pre>
</div>

<p>
変更箇所は次の通り．
</p>
<ul class="org-ul">
<li>initializeはconf_pathを受け取るが，指定されてない時はnil</li>
<li>これを@conf_pathに受け渡すが，defaultをENV['HOME']に指定</li>
<li>これでデフォルトのconfigurationを変更していく
やり方は，
<a href="https://stackoverflow.com/questions/6233124/where-to-place-access-config-file-in-gem">Where to place/access config file in gem?</a>
を参照する．</li>
</ul>

<p>
これによってTest::unitでのtest環境独自のmy_help環境を構築することが
できる．
</p>
</div>
</div>

<div id="outline-container-org2aec50d" class="outline-2">
<h2 id="org2aec50d"><span class="section-number-2">4.</span> <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-11-08 Mon&gt; </span></span> conf_pathをactivate</h2>
<div class="outline-text-2" id="text-4">
<p>
testが進んできたので，conf_pathをactivateした．
そのためのテストが必要かも．
</p>

<ol class="org-ol">
<li>ENV['HOME']で指定した時と．．．</li>
<li>pwdで何もない時のoptionsがどうなっている？</li>
</ol>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #2e8b57;">config</span>:
  <span style="color: #2e8b57;">:template_dir</span>: <span style="color: #8b7355;">"/Users/bob/git_hub/my_help/lib/templates"</span>
  <span style="color: #2e8b57;">:local_help_dir</span>: <span style="color: #8b7355;">"/Users/bob/git_hub/my_help/test/.my_help"</span>
  <span style="color: #2e8b57;">:conf_file</span>: <span style="color: #8b7355;">"/Users/bob/git_hub/my_help/test/.my_help/.my_help_conf.yml"</span>
  <span style="color: #2e8b57;">:editor</span>: emacs
</pre>
</div>
</div>
</div>

<div id="outline-container-org20943ec" class="outline-2">
<h2 id="org20943ec"><span class="section-number-2">5.</span> <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-11-08 Mon&gt; </span></span> bundle exec exe/my_help editでエラー</h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">
<pre class="src src-shell">Could not find ffi-1.15.4<span style="color: #1c86ee;"> in</span> any of the sources
Run <span style="color: #ff00ff;">`bundle install`</span> to install missing gems.
</pre>
</div>
<p>
とのエラー．
なんだろう．
</p>

<p>
さらに，command_lineで呼ぶと，
</p>
<pre class="example">
emacs: standard input is not a tty
</pre>

<p>
というエラーが出る．これまたなんだろう？？？
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Shigeto R. Nishitani</p>
<p class="date">Created: 2023-01-05 Thu 15:58</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
